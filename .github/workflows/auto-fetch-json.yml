name: Auto Fetch JSON Data

on:
  schedule:
    # æ¯å°æ—¶çš„ç¬¬ 0 åˆ†é’Ÿè¿è¡Œï¼ˆUTC æ—¶é—´ï¼‰
    - cron: '0 * * * *'
  workflow_dispatch:  # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  auto-fetch-json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: 'main'
          token: ${{ secrets.ACTION_TOKEN }}

      - name: Fetch latest JSON data
        id: fetch
        run: |
          # è·å–æœ€æ–°æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶
          curl -f -s -S --max-time 10 \
            https://api.dabing.one?whiteboard_id=76bdbed57a91aa4e93c43452bc55b87013ad17c12792a8c50614b628947cf8e4 \
            > data.json.new || {
            echo "âŒ Failed to fetch data from API"
            exit 1
          }
          echo "âœ… Successfully fetched latest data from API"
          
      - name: Check if data changed
        id: check
        run: |
          # æ£€æŸ¥æ•°æ®æ˜¯å¦å˜åŒ–
          if [ -f src/resources/data.json ]; then
            # ä½¿ç”¨ SHA256 å“ˆå¸Œæ¯”è¾ƒ
            OLD_HASH=$(sha256sum src/resources/data.json | cut -d' ' -f1)
            NEW_HASH=$(sha256sum data.json.new | cut -d' ' -f1)
            
            if [ "$OLD_HASH" == "$NEW_HASH" ]; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  Data unchanged - no changes detected"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "ğŸ”„ Data changed - will commit and deploy"
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ No existing data.json found - will create"
          fi
          
          # ç§»åŠ¨æ–°æ•°æ®åˆ°ç›®æ ‡ä½ç½®
          mv data.json.new src/resources/data.json

      - name: Auto commit and deploy (only if changed)
        if: steps.check.outputs.changed == 'true'
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          git checkout -B main 
          git pull origin main --rebase || true
          git add src/resources/data.json
          git commit -m "Auto-update: Heptabase changes detected [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]"
          git push origin main
          echo "âœ… Data committed and pushed - Vercel will deploy automatically"
        env:
          GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN }}
      
      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "${{ steps.check.outputs.changed }}" == "true" ]; then
            echo "âœ… SUCCESS: Data updated automatically"
            echo "ğŸ”„ Changes detected from Heptabase"
            echo "ğŸš€ Vercel deployment will be triggered"
            echo "â° Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          else
            echo "â­ï¸  No changes detected"
            echo "ğŸ’¡ Next check in 1 hour"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

